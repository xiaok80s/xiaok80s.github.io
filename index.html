<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Audio Player</title>

    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="default" />
    <meta name="apple-mobile-web-app-title" content="Audio Player" />
    <meta name="mobile-web-app-capable" content="yes" />
    <meta name="theme-color" content="#4a90e2" />

    <link
      rel="apple-touch-icon"
      sizes="180x180"
      href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTgwIiBoZWlnaHQ9IjE4MCIgdmlld0JveD0iMCAwIDE4MCAxODAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PHJlY3Qgd2lkdGg9IjE4MCIgaGVpZ2h0PSIxODAiIHJ4PSIyMCIgZmlsbD0iIzRhOTBlMiIvPjxzdmcgeD0iNDUiIHk9IjQ1IiB3aWR0aD0iOTAiIGhlaWdodD0iOTAiIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0id2hpdGUiPjxwYXRoIGQ9Ik04IDV2MTRsNy03eiIvPjwvc3ZnPjwvc3ZnPg==" />
    <link
      rel="icon"
      type="image/svg+xml"
      href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzIiIGhlaWdodD0iMzIiIHZpZXdCb3g9IjAgMCAzMiAzMiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMzIiIGhlaWdodD0iMzIiIHJ4PSI0IiBmaWxsPSIjNGE5MGUyIi8+PHN2ZyB4PSI4IiB5PSI4IiB3aWR0aD0iMTYiIGhlaWdodD0iMTYiIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0id2hpdGUiPjxwYXRoIGQ9Ik04IDV2MTRsNy03eiIvPjwvc3ZnPjwvc3ZnPg==" />

    <link
      rel="manifest"
      href="data:application/json;base64,eyJuYW1lIjogIkF1ZGlvIFBsYXllciIsICJzaG9ydF9uYW1lIjogIkF1ZGlvIFBsYXllciIsICJkZXNjcmlwdGlvbiI6ICJBIG1pbmltYWwgYXVkaW8gcGxheWVyIHdpdGggc2VudGVuY2UgZGV0ZWN0aW9uIGFuZCBzdWJ0aXRsZSBzdXBwb3J0IiwgInN0YXJ0X3VybCI6ICIuIiwgImRpc3BsYXkiOiAic3RhbmRhbG9uZSIsICJiYWNrZ3JvdW5kX2NvbG9yIjogIiNmNWY3ZmEiLCAidGhlbWVfY29sb3IiOiAiIzRhOTBlMiIsICJpY29ucyI6IFt7InNyYyI6ICJkYXRhOmltYWdlL3N2Zyt4bWw7YmFzZTY0LFBITjJaeUIzYVdSMGFEMGlOVEV5SWlCb1pXbG5hSFE5SWpVeE1pSWdkbWxsZDBKdmVEMGlNQ0F3SURVeE1pQTFNVElpSUdacGJHdzlJbTV2Ym1VaUlIaHRiRzV6UFNKb2RIUndPaTh2ZDNkM0xuY3pMbTl5Wnk4eU1EQXdMM04yWnlJK1BISmxZM1FnZDJsa2RHZzlJalV4TWlJZ2FHVnBaMmgwUFNJMU1USWlJSEo0UFNJMU1DSWdabWxzYkQwaUl6UmhPVEJsTWlJdlBqeHpkbWNnZUQwaU1USTRJaUI1UFNJeE1qZ2lJSGRwWkhSb1BTSXlOVFlpSUdobGFXZG9kRDBpTWpVMklpQjJhV1YzUW05NFBTSXdJREFnTWpRZ01qUWlJR1pwYkd3OUluZG9hWFJsSWo0OGNHRjBhQ0JrUFNKTk9DQTFkakUwYkRjdE4zb2lMejQ4TDNOMlp6NDhMM04yWno0PSIsICJzaXplcyI6ICI1MTJ4NTEyIiwgInR5cGUiOiAiaW1hZ2Uvc3ZnK3htbCJ9LCB7InNyYyI6ICJkYXRhOmltYWdlL3N2Zyt4bWw7YmFzZTY0LFBITjJaeUIzYVdSMGFEMGlNVGt5SWlCb1pXbG5hSFE5SWpFNU1pSWdkbWxsZDBKdmVEMGlNQ0F3SURFNU1pQXhPVElpSUdacGJHdzlJbTV2Ym1VaUlIaHRiRzV6UFNKb2RIUndPaTh2ZDNkM0xuY3pMbTl5Wnk4eU1EQXdMM04yWnlJK1BISmxZM1FnZDJsa2RHZzlJakU1TWlJZ2FHVnBaMmgwUFNJeE9USWlJSEo0UFNJeU1DSWdabWxzYkQwaUl6UmhPVEJsTWlJdlBqeHpkbWNnZUQwaU5EZ2lJSGs5SWpRNElpQjNhV1IwYUQwaU9UWWlJR2hsYVdkb2REMGlPVFlpSUhacFpYZENiM2c5SWpBZ01DQXlOQ0F5TkNJZ1ptbHNiRDBpZDJocGRHVWlQanh3WVhSb0lHUTlJazA0SURWMk1UUnNOeTAzZWlJdlBqd3ZjM1puUGp3dmMzWm5QZz09IiwgInNpemVzIjogIjE5MngxOTIiLCAidHlwZSI6ICJpbWFnZS9zdmcreG1sIn1dLCAib3JpZW50YXRpb24iOiAicG9ydHJhaXQifQ==" />
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: 'Arial', sans-serif;
        background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        min-height: 100vh;
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 20px;
        overflow: hidden;
        position: fixed;
        width: 100%;
        height: 100%;
        margin: 0;
        user-select: none;
        -webkit-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
      }

      .container {
        background: white;
        border-radius: 20px;
        padding: 40px;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        text-align: center;
        max-width: 500px;
        width: 100%;
        position: relative;
        user-select: none;
        -webkit-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        -webkit-user-drag: none;
        -khtml-user-drag: none;
        -moz-user-drag: none;
        -o-user-drag: none;
        pointer-events: auto;
        touch-action: manipulation;
      }

      h1 {
        color: #333;
        margin-bottom: 30px;
        font-size: 2rem;
        font-weight: 300;
      }

      .file-info {
        margin-bottom: 30px;
        padding: 15px;
        background: #f8f9fa;
        border-radius: 10px;
        color: #666;
        font-size: 0.9rem;
        flex: 1;
        text-align: left;
        margin-right: 15px;
        margin-bottom: 0;
      }

      .file-row {
        display: flex;
        align-items: center;
        margin-bottom: 30px;
        gap: 15px;
      }

      .file-row .open-file {
        margin: 0;
        flex-shrink: 0;
      }

      .controls {
        display: flex;
        justify-content: center;
        gap: 15px;
        margin-bottom: 30px;
        flex-wrap: wrap;
      }

      button {
        background: #4a90e2;
        color: white;
        border: none;
        border-radius: 50px;
        padding: 12px 20px;
        font-size: 0.9rem;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 8px;
        box-shadow: 0 4px 15px rgba(74, 144, 226, 0.3);
      }

      button:hover {
        background: #357abd;
        box-shadow: 0 6px 20px rgba(74, 144, 226, 0.4);
      }

      /* Keep hover transform effect only on devices that support hover (desktop) */
      @media (hover: hover) and (pointer: fine) {
        button:hover {
          transform: translateY(-2px);
        }
      }

      /* iOS Safari touch handling */
      button {
        -webkit-touch-callout: none;
        -webkit-user-select: none;
        user-select: none;
        -webkit-tap-highlight-color: rgba(0, 0, 0, 0);
        touch-action: manipulation;
      }

      button:disabled {
        background: #ccc;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
      }

      .open-file {
        background: #28a745;
        box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);
      }

      .open-file:hover {
        background: #218838;
        box-shadow: 0 6px 20px rgba(40, 167, 69, 0.4);
      }

      .open-file[style*='background: #17a2b8']:hover {
        background: #138496 !important;
        box-shadow: 0 6px 20px rgba(23, 162, 184, 0.4) !important;
      }

      .nav-button {
        background: #6c757d;
        box-shadow: 0 4px 15px rgba(108, 117, 125, 0.3);
      }

      .nav-button:hover {
        background: #5a6268;
        box-shadow: 0 6px 20px rgba(108, 117, 125, 0.4);
      }

      .hidden {
        display: none !important;
      }

      .lyrics-toggle {
        background: #17a2b8;
        box-shadow: 0 4px 15px rgba(23, 162, 184, 0.3);
        font-size: 0.9rem;
        padding: 8px 16px;
        display: flex;
        align-items: center;
        gap: 6px;
      }

      .lyrics-toggle:hover {
        background: #138496;
        box-shadow: 0 6px 20px rgba(23, 162, 184, 0.4);
      }

      .lyrics-toggle.active {
        background: #28a745;
        box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);
      }

      .lyrics-toggle.active:hover {
        background: #218838;
        box-shadow: 0 6px 20px rgba(40, 167, 69, 0.4);
      }

      .toggle-icon {
        font-size: 1rem;
        transition: transform 0.2s ease;
      }

      .lyrics-toggle.active .toggle-icon {
        transform: rotate(180deg);
      }

      /* Toggle buttons container */
      .toggle-buttons-container {
        display: flex;
        justify-content: center;
        align-items: center;
        flex-wrap: wrap;
        gap: 10px;
        margin-bottom: 20px;
      }

      /* Desktop-only hover transform effects */
      @media (hover: hover) and (pointer: fine) {
        button:active {
          transform: translateY(0);
        }
      }

      .progress-container {
        margin-bottom: 20px;
      }

      .progress-bar {
        width: 100%;
        height: 8px;
        background: #e9ecef;
        border-radius: 10px;
        overflow: hidden;
        cursor: pointer;
        box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
        position: relative;
      }

      .progress-fill {
        height: 100%;
        background: linear-gradient(90deg, #4a90e2, #357abd);
        width: 0%;
        transition: width 0.1s ease;
        border-radius: 10px;
      }

      .segment-marker {
        position: absolute;
        top: 0;
        width: 2px;
        height: 100%;
        background: #28a745;
        opacity: 0.7;
        pointer-events: none;
      }

      .current-segment-marker {
        background: #fd7e14;
        width: 3px;
        opacity: 1;
      }
      .time-display {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 10px;
        font-size: 0.9rem;
        color: #666;
      }

      .speed-controls {
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .speed-btn {
        background: #6c757d;
        color: white;
        border: none;
        border-radius: 50%;
        width: 30px;
        height: 30px;
        font-size: 0.8rem;
        cursor: pointer;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 0;
        box-shadow: 0 2px 8px rgba(108, 117, 125, 0.3);
      }

      .speed-btn:hover {
        background: #5a6268;
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(108, 117, 125, 0.4);
      }

      .speed-btn:disabled {
        background: #ccc;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
      }

      .speed-display {
        font-size: 0.8rem;
        color: #666;
        min-width: 35px;
        text-align: center;
      }

      .icon {
        font-size: 1.2rem;
      }

      input[type='file'] {
        display: none;
      }

      .current-text {
        margin-top: 25px;
        padding: 20px;
        background: linear-gradient(135deg, #fff9e6 0%, #f0f8ff 100%);
        border-radius: 15px;
        border: 2px solid #e3f2fd;
        min-height: 80px;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .text-content {
        font-size: 1.1rem;
        line-height: 1.6;
        color: #333;
        text-align: center;
        font-weight: 500;
        max-width: 100%;
        word-wrap: break-word;
      }

      .text-content.highlighted {
        animation: pulse 0.3s ease;
      }

      /* Enhanced LRC word-level highlighting styles */
      .text-content.enhanced-lrc {
        font-size: 1.1rem;
        line-height: 1.6;
      }

      .word-normal {
        color: #666;
      }

      .word-highlight {
        color: #4a90e2;
        font-weight: 600;
      }

      @keyframes pulse {
        0% {
          transform: scale(1);
        }
        50% {
          transform: scale(1.02);
        }
        100% {
          transform: scale(1);
        }
      }

      @media (max-width: 600px) {
        .container {
          padding: 20px;
        }

        h1 {
          font-size: 1.5rem;
          margin-bottom: 20px;
        }

        .file-row {
          flex-direction: column;
          gap: 10px;
          margin-bottom: 20px;
        }

        .file-info {
          margin-bottom: 10px;
          padding: 10px;
          font-size: 0.8rem;
          margin-right: 0;
          text-align: center;
          width: 100%;
        }

        .file-row .open-file {
          width: 100%;
        }

        .controls {
          flex-direction: row;
          flex-wrap: nowrap;
          gap: 8px;
          margin-bottom: 20px;
        }

        button {
          min-width: auto;
          padding: 10px 12px;
          font-size: 0.8rem;
          flex: 1;
          justify-content: center;
        }

        .nav-button {
          flex: 1;
          min-width: 0;
        }

        .lyrics-toggle-container {
          margin-bottom: 15px;
        }

        .toggle-buttons-container {
          margin-bottom: 15px;
          gap: 8px;
        }

        .lyrics-toggle {
          padding: 6px 12px;
          font-size: 0.8rem;
        }

        .progress-container {
          margin-bottom: 15px;
        }

        .current-text {
          margin-top: 15px;
          padding: 15px;
          min-height: 60px;
        }

        .text-content {
          font-size: 1rem;
          line-height: 1.4;
        }

        /* Mobile word highlighting adjustments */
        .word-highlight {
          font-size: 0.95rem;
        }

        .word-normal {
          font-size: 0.95rem;
        }
      }

      @media (max-width: 400px) {
        .container {
          padding: 15px;
        }

        h1 {
          font-size: 1.3rem;
          margin-bottom: 15px;
        }

        .file-row {
          gap: 8px;
          margin-bottom: 15px;
        }

        .file-info {
          margin-bottom: 8px;
          padding: 8px;
          font-size: 0.75rem;
        }

        .controls {
          gap: 6px;
          margin-bottom: 15px;
        }

        button {
          padding: 8px 10px;
          font-size: 0.75rem;
        }

        .nav-button {
          flex: 1;
          min-width: 0;
        }

        .lyrics-toggle-container {
          margin-bottom: 12px;
        }

        .toggle-buttons-container {
          margin-bottom: 12px;
          gap: 6px;
        }

        .lyrics-toggle {
          padding: 5px 10px;
          font-size: 0.75rem;
        }

        .file-row .open-file {
          padding: 10px 15px;
          font-size: 0.85rem;
        }

        .icon {
          font-size: 1rem;
        }

        .progress-bar {
          height: 6px;
        }

        .time-display {
          font-size: 0.8rem;
          margin-top: 8px;
        }

        .current-text {
          margin-top: 12px;
          padding: 12px;
          min-height: 50px;
        }

        .text-content {
          font-size: 0.9rem;
          line-height: 1.3;
        }

        /* Small mobile word highlighting adjustments */
        .word-highlight {
          font-size: 0.85rem;
        }

        .word-normal {
          font-size: 0.85rem;
        }
      }

      /* Help Overlay Styles */
      #helpOverlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.8);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 1000;
        opacity: 0;
        transition: opacity 0.3s ease;
      }

      #helpOverlay.show {
        opacity: 1;
      }

      .help-content {
        background: white;
        padding: 30px;
        border-radius: 15px;
        max-width: 400px;
        width: 90%;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        text-align: center;
        transform: scale(0.9);
        transition: transform 0.3s ease;
      }

      #helpOverlay.show .help-content {
        transform: scale(1);
      }

      .help-content h3 {
        margin-bottom: 20px;
        color: #333;
        font-size: 1.4rem;
      }

      .shortcut-list {
        text-align: left;
        margin-bottom: 20px;
      }

      .shortcut-list div {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px 0;
        border-bottom: 1px solid #eee;
      }

      .shortcut-list div:last-child {
        border-bottom: none;
      }

      kbd {
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 4px;
        padding: 4px 8px;
        font-family: monospace;
        font-size: 0.9rem;
        color: #495057;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      }

      .help-note {
        font-size: 0.9rem;
        color: #666;
        margin: 0;
        font-style: italic;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>üéµ Audio Player</h1>

      <div class="file-row">
        <div class="file-info" id="fileInfo">No audio file selected</div>
        <button
          class="open-file"
          onclick="handleFileButtonClick(event)"
          style="background: #17a2b8; box-shadow: 0 4px 15px rgba(23, 162, 184, 0.3)">
          <span class="icon">üéµ</span>
          Load Files
        </button>
      </div>

      <div class="controls">
        <button class="nav-button" onclick="playPreviousSentence()" disabled>Prev</button>

        <button class="nav-button" onclick="playNextSentence()" disabled>Next</button>

        <button id="playPauseBtn" onclick="togglePlayPause()" disabled>Play</button>
      </div>

      <div class="toggle-buttons-container">
        <button
          class="lyrics-toggle active hidden"
          id="autoStopToggleBtn"
          onclick="toggleAutoStop()">
          <span id="autoStopToggleText">Sentence On</span>
        </button>
        <button 
          class="lyrics-toggle hidden" 
          id="lyricsToggleBtn" 
          onclick="toggleLyrics()">
          <span id="lyricsToggleText">Show Lyrics</span>
        </button>
      </div>

      <div class="progress-container">
        <div class="progress-bar" onclick="seekAudio(event)">
          <div class="progress-fill" id="progressFill"></div>
        </div>
        <div class="time-display">
          <span id="currentTime">0:00</span>
          <div class="speed-controls">
            <button
              class="speed-btn"
              id="speedDownBtn"
              onclick="decreaseSpeed()"
              disabled
              title="Decrease Speed">
              ‚àí
            </button>
            <span class="speed-display" id="speedDisplay">1.0x</span>
            <button
              class="speed-btn"
              id="speedResetBtn"
              onclick="resetSpeed()"
              disabled
              title="Reset Speed">
              ‚óã
            </button>
            <button
              class="speed-btn"
              id="speedUpBtn"
              onclick="increaseSpeed()"
              disabled
              title="Increase Speed">
              +
            </button>
          </div>
          <span id="duration">0:00</span>
        </div>
      </div>

      <div class="current-text" id="currentText" style="display: none">
        <div class="text-content" id="textContent">
          Load audio and LRC files together to see synchronized text here.
        </div>
      </div>

      <input
        type="file"
        id="bothFilesInput"
        accept="*/*"
        multiple
        onchange="loadBothFiles(event)" />
      <audio id="audioPlayer" onended="onAudioEnded()" loop></audio>

      <div id="helpOverlay">
        <div class="help-content">
          <h3>‚å®Ô∏è Keyboard Shortcuts</h3>
          <div class="shortcut-list">
            <div><kbd>J</kbd> Play Previous</div>
            <div><kbd>L</kbd> Play Next</div>
            <div><kbd>K</kbd> Play/Pause</div>
            <div><kbd>U</kbd> Speed Down</div>
            <div><kbd>N</kbd> Speed Up</div>
            <div><kbd>M</kbd> Reset Speed</div>
            <div><kbd>A</kbd> Toggle Auto-Stop</div>
            <div><kbd>O</kbd> Load Files</div>
            <div><kbd>T</kbd> Toggle Lyrics</div>
            <div><kbd>H</kbd> Toggle Help</div>
            <div><kbd>Esc</kbd> Close Help</div>
          </div>
          <p class="help-note">üí° Click anywhere or press Esc to close</p>
        </div>
      </div>
    </div>

    <script>
      // Global variables
      let audioPlayer = document.getElementById('audioPlayer');
      let progressFill = document.getElementById('progressFill');
      let currentTimeSpan = document.getElementById('currentTime');
      let durationSpan = document.getElementById('duration');
      let fileInfoDiv = document.getElementById('fileInfo');
      let currentTextDiv = document.getElementById('currentText');
      let textContentDiv = document.getElementById('textContent');

      let isPlaying = false;
      let currentSentenceIndex = 0;
      let sentences = []; 
      let currentFileName = '';
      
      // LRC-related variables
      let lrcData = []; 
      let currentLrcIndex = -1;
      let lrcLoaded = false;
      let lyricsVisible = false; 

      // Sentence-by-sentence playback
      let sentenceMode = true; 
      const PADDING_TIME = 0.2; // Seconds to start earlier

      // Initialize event listeners
      audioPlayer.addEventListener('timeupdate', updateProgress);
      audioPlayer.addEventListener('loadedmetadata', onAudioLoaded);
      audioPlayer.addEventListener('play', onPlay);
      audioPlayer.addEventListener('pause', onPause);
      audioPlayer.addEventListener('ended', onAudioEnded);

      // Initialize lyrics toggle visibility
      updateLyricsToggleVisibility();

      // Utility function to detect iOS
      function isIOS() {
        return (
          /iPad|iPhone|iPod/.test(navigator.userAgent) ||
          (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1)
        );
      }

      async function handleFileButtonClick(event) {
        event.preventDefault();
        
        // Try to use the File System Access API if available (Desktop Chrome/Edge)
        // This API allows remembering the last location via the 'id' parameter
        if (window.showOpenFilePicker) {
            try {
                const handles = await window.showOpenFilePicker({
                    id: 'dictice-player-location', // Browser remembers directory for this ID
                    multiple: true,
                    types: [{
                        description: 'Audio & Lyrics',
                        accept: {
                            'audio/*': ['.mp3', '.wav', '.ogg', '.m4a', '.aac', '.flac'],
                            'text/plain': ['.lrc', '.txt']
                        }
                    }]
                });
                
                const files = await Promise.all(handles.map(h => h.getFile()));
                processFiles(files);
            } catch (err) {
                // Ignore user cancellation (AbortError)
                if (err.name !== 'AbortError') {
                    console.warn('File picker failed, falling back to input:', err);
                    document.getElementById('bothFilesInput').click();
                }
            }
        } else {
            // Fallback for Safari/Firefox/Mobile
            document.getElementById('bothFilesInput').click();
        }
      }

      function clearCurrentAudioAndLyrics() {
        audioPlayer.pause();
        audioPlayer.src = '';
        isPlaying = false;
        currentSentenceIndex = 0;
        sentences = [];
        lrcData = [];
        lrcLoaded = false;
        lyricsVisible = false;
        
        fileInfoDiv.textContent = 'No audio file selected';
        currentTimeSpan.textContent = '0:00';
        durationSpan.textContent = '0:00';
        progressFill.style.width = '0%';
        
        currentTextDiv.style.display = 'none';
        textContentDiv.textContent = 'Load audio and LRC files together to see synchronized text here.';
        
        updateLyricsToggleVisibility();
        disableControls();
      }

      function loadBothFiles(event) {
        const files = Array.from(event.target.files);
        processFiles(files);
        event.target.value = '';
      }

      function processFiles(files) {
        if (files.length === 0) return;

        clearCurrentAudioAndLyrics();

        // Improved detection to handle cases where MIME type might be missing
        let audioFile = files.find(f => f.type.startsWith('audio/') || /\.(mp3|wav|ogg|m4a|aac|flac)$/i.test(f.name));
        let lrcFile = files.find(f => f.name.toLowerCase().endsWith('.lrc') || f.name.toLowerCase().endsWith('.txt'));

        if (audioFile) {
            loadAudioFileInternal(audioFile, () => {
                if (lrcFile) {
                    loadLrcFileInternal(lrcFile);
                } else {
                    // Only audio loaded
                    updateStatus('Audio loaded. No lyrics.', 'stopped');
                    sentences = [{start: 0, end: audioPlayer.duration, text: "Full Audio"}];
                    enableControls();
                    audioPlayer.play();
                }
            });
        }
      }

      function loadAudioFileInternal(file, callback) {
        const url = URL.createObjectURL(file);
        audioPlayer.src = url;
        currentFileName = file.name;
        fileInfoDiv.innerHTML = `<strong>üìÑ ${currentFileName}</strong>`;
        
        audioPlayer.onloadedmetadata = () => {
            if (callback) callback();
        };
      }

      function loadLrcFileInternal(file) {
        const reader = new FileReader();
        reader.onload = (e) => {
            lrcData = parseLrcContent(e.target.result);
            if (lrcData.length > 0) {
                lrcLoaded = true;
                generateSentencesFromLrc();
                updateStatus(`Loaded ${lrcData.length} lines.`, 'stopped');
                updateLyricsToggleVisibility();
                
                // Hide lyrics initially as requested
                lyricsVisible = false;
                currentTextDiv.style.display = 'none';
                document.getElementById('lyricsToggleBtn').classList.remove('active');
                document.getElementById('lyricsToggleText').textContent = 'Show Lyrics';

                enableControls();
                audioPlayer.play();
            }
        };
        reader.readAsText(file);
      }

      function parseLrcContent(content) {
        const lines = content.split('\n');
        const data = [];
        const timeRegex = /\[(\d{2}):(\d{2})(?:\.(\d{2,3}))?\](.*)/;
        
        for (const line of lines) {
            const match = line.match(timeRegex);
            if (match) {
                const min = parseInt(match[1]);
                const sec = parseInt(match[2]);
                const ms = match[3] ? parseInt(match[3].padEnd(3, '0')) : 0; // Handle 2 or 3 digit ms
                const time = min * 60 + sec + ms / 1000;
                const text = match[4].trim();
                if (text) { // Only add non-empty lines
                    data.push({ time, text });
                }
            }
        }
        return data.sort((a, b) => a.time - b.time);
      }

      function generateSentencesFromLrc() {
        sentences = [];
        for (let i = 0; i < lrcData.length; i++) {
            const current = lrcData[i];
            const next = lrcData[i + 1];
            
            // Start a bit earlier
            let start = Math.max(0, current.time - PADDING_TIME);
            
            // End at the start of the next line (or end of audio)
            // We don't subtract padding from end, to ensure we hear the full line even if it runs late
            let end = next ? next.time : audioPlayer.duration;
            
            sentences.push({
                start: start,
                end: end,
                text: current.text
            });
        }
      }

      function togglePlayPause() {
        if (audioPlayer.paused) {
            if (sentenceMode && sentences.length > 0 && lrcLoaded) {
                // In sentence mode, Play button repeats current sentence
                playSingleSentence();
            } else {
                audioPlayer.play();
            }
        } else {
            audioPlayer.pause();
        }
      }

      function playSingleSentence() {
        if (currentSentenceIndex < 0 || currentSentenceIndex >= sentences.length) return;
        
        const sentence = sentences[currentSentenceIndex];
        audioPlayer.currentTime = sentence.start;
        audioPlayer.play();
        updateStatus(`Playing line ${currentSentenceIndex + 1}`, 'playing');
        updateCurrentSegmentMarker();
      }

      function playNextSentence() {
        if (!lrcLoaded) {
            audioPlayer.currentTime = Math.min(audioPlayer.duration, audioPlayer.currentTime + 5);
            return;
        }
        if (currentSentenceIndex < sentences.length - 1) {
            currentSentenceIndex++;
            if (sentenceMode) {
                playSingleSentence();
            } else {
                // In normal mode, just seek to next start
                audioPlayer.currentTime = sentences[currentSentenceIndex].start;
                if (audioPlayer.paused) audioPlayer.play();
            }
        }
      }

      function playPreviousSentence() {
        if (!lrcLoaded) {
            audioPlayer.currentTime = Math.max(0, audioPlayer.currentTime - 5);
            return;
        }
        if (currentSentenceIndex > 0) {
            currentSentenceIndex--;
            if (sentenceMode) {
                playSingleSentence();
            } else {
                audioPlayer.currentTime = sentences[currentSentenceIndex].start;
                if (audioPlayer.paused) audioPlayer.play();
            }
        }
      }

      function updateProgress() {
        const currentTime = audioPlayer.currentTime;
        const duration = audioPlayer.duration;
        
        if (duration) {
            progressFill.style.width = (currentTime / duration) * 100 + '%';
            currentTimeSpan.textContent = formatTime(currentTime);
        }

        // Auto-stop logic for Sentence Mode
        if (sentenceMode && isPlaying && sentences.length > 0) {
            const currentSentence = sentences[currentSentenceIndex];
            // Check if we passed the end time
            // We add a small buffer (0.1s) to prevent premature pausing if update frequency is low
            // But user wants to hear complete line.
            if (currentTime >= currentSentence.end) {
                audioPlayer.pause();
                updateStatus(`Paused after line ${currentSentenceIndex + 1}`, 'paused');
            }
        }
        
        // Update current sentence index if playing continuously (Normal Mode)
        // Or if user seeked manually
        if (!sentenceMode || !isPlaying) {
             // Find which sentence we are in
             // This is simple linear search, can be optimized but fine for small N
             for(let i=0; i<sentences.length; i++) {
                 // We use the original LRC times for "current" detection to be more accurate visually
                 // But here we use the calculated sentence boundaries
                 if (currentTime >= sentences[i].start && currentTime < sentences[i].end) {
                     if (currentSentenceIndex !== i) {
                         currentSentenceIndex = i;
                         updateCurrentSegmentMarker();
                     }
                     break;
                 }
             }
        }

        if (lyricsVisible) {
            updateCurrentText(currentTime);
        }
      }

      function updateCurrentText(time) {
          // Find active lyric based on time
          // We can use currentSentenceIndex since it's synced
          if (currentSentenceIndex >= 0 && currentSentenceIndex < sentences.length) {
              textContentDiv.textContent = sentences[currentSentenceIndex].text;
              textContentDiv.className = 'text-content highlighted';
          }
      }

      function toggleLyrics() {
        lyricsVisible = !lyricsVisible;
        currentTextDiv.style.display = lyricsVisible ? 'flex' : 'none';
        document.getElementById('lyricsToggleBtn').classList.toggle('active', lyricsVisible);
        document.getElementById('lyricsToggleText').textContent = lyricsVisible ? 'Hide Lyrics' : 'Show Lyrics';
        if (lyricsVisible) updateCurrentText(audioPlayer.currentTime);
      }

      function toggleAutoStop() {
        sentenceMode = !sentenceMode;
        const btn = document.getElementById('autoStopToggleBtn');
        const text = document.getElementById('autoStopToggleText');
        
        if (sentenceMode) {
            btn.classList.add('active');
            text.textContent = 'Sentence On';
        } else {
            btn.classList.remove('active');
            text.textContent = 'Sentence Off';
        }
      }

      // Helper functions
      function formatTime(seconds) {
        const mins = Math.floor(seconds / 60);
        const secs = Math.floor(seconds % 60);
        return `${mins}:${secs.toString().padStart(2, '0')}`;
      }

      function updateStatus(msg, type) {
        // Status display removed
      }

      function onPlay() {
        isPlaying = true;
        updateStatus('Playing', 'playing');
        document.getElementById('playPauseBtn').textContent = 'Pause';
      }

      function onPause() {
        isPlaying = false;
        updateStatus('Paused', 'paused');
        document.getElementById('playPauseBtn').textContent = 'Play';
      }
      
      function onAudioEnded() {
          isPlaying = false;
          updateStatus('Ended', 'stopped');
          document.getElementById('playPauseBtn').textContent = 'Play';
      }

      function onAudioLoaded() {
        durationSpan.textContent = formatTime(audioPlayer.duration);
        visualizeSegments();
      }

      function enableControls() {
        document.querySelectorAll('button').forEach(b => b.disabled = false);
      }
      
      function disableControls() {
         // Keep Load button enabled
         document.querySelectorAll('button:not(.open-file)').forEach(b => b.disabled = true);
      }

      function updateLyricsToggleVisibility() {
          const lyricsBtn = document.getElementById('lyricsToggleBtn');
          const autoStopBtn = document.getElementById('autoStopToggleBtn');
          
          if (lrcLoaded) {
              lyricsBtn.classList.remove('hidden');
              autoStopBtn.classList.remove('hidden');
          } else {
              lyricsBtn.classList.add('hidden');
              autoStopBtn.classList.add('hidden');
          }
      }

      function visualizeSegments() {
          const bar = document.querySelector('.progress-bar');
          bar.querySelectorAll('.segment-marker').forEach(m => m.remove());
          
          sentences.forEach((s, i) => {
              const m = document.createElement('div');
              m.className = 'segment-marker';
              m.style.left = (s.start / audioPlayer.duration * 100) + '%';
              bar.appendChild(m);
          });
          updateCurrentSegmentMarker();
      }

      function updateCurrentSegmentMarker() {
          const markers = document.querySelectorAll('.segment-marker');
          markers.forEach((m, i) => {
              if (i === currentSentenceIndex) m.classList.add('current-segment-marker');
              else m.classList.remove('current-segment-marker');
          });
      }
      
      function seekAudio(event) {
          const rect = event.currentTarget.getBoundingClientRect();
          const x = event.clientX - rect.left;
          const p = x / rect.width;
          audioPlayer.currentTime = p * audioPlayer.duration;
          // If in sentence mode, we might want to snap to the nearest sentence or just play from there
          // For simplicity, just let it play, updateProgress will handle index update
      }
      
      // Speed controls
      function decreaseSpeed() { audioPlayer.playbackRate = Math.max(0.5, audioPlayer.playbackRate - 0.1); updateSpeedDisplay(); }
      function increaseSpeed() { audioPlayer.playbackRate = Math.min(2.0, audioPlayer.playbackRate + 0.1); updateSpeedDisplay(); }
      function resetSpeed() { audioPlayer.playbackRate = 1.0; updateSpeedDisplay(); }
      function updateSpeedDisplay() { document.getElementById('speedDisplay').textContent = audioPlayer.playbackRate.toFixed(1) + 'x'; }

    </script>
  </body>
</html>
